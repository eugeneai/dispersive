source('global.R')

STEP=FWHM/4.0/sc

scaled.X=function (x0=0, sc=1) {
        s = chan.nos - x0
        s = s * SC
        s
}

plot.xrf.spec = function (spectrum, x0=0, sc=1, col='red') {
        s = scaled.X(x0=x0, sc=sc)         
        plot(s, spectrum, type='l', col=col)
}

line.xrf.mark = function(ev, spectrum, col='green') {
        lines(c(ev, ev), c(0,max(spectrum)/2.), col=col)
}

find_pike = function (start_x0=97, spectrum, step=STEP, channels=3*FWHM/sc, eps=1.0, plot=FALSE, fit_fwhm=TRUE) {
    x0 = start_x0 - as.integer(channels/2.0)
    term_x = x0 + channels
    p_sg = 1e38
    s = step
    f = list()
    phase = 'raw'
    # scanning the interval of channels around start_x0
    repeat {
        if (x0>term_x) {
           f$found=FALSE
           break;
        }
        g = gauss(chan.nos,x0=x0, zc=0, A=1, sc=sc)
        if (phase=='prec') {
           mm = mask(g, level=0.001)
           fm = spectrum ~ g + 0
        } else {
           mm = O
           fm = spectrum ~ g
        }
        f = lm(fm, weights=mm)
        cfs = f$coefficients
        if (length(cfs)==2) { 
           a = cfs[2] 
           b = cfs[1]
        } else {
           a = cfs[1]
           b = 0
        }

        sm = summary(f)
        sg = sm$sigma
        print (c(a, sg, x0, s, b))
        if ((b>=0 || phase=='prec') && a>0){ 
           if (sg > p_sg)
              s = -s/2.0
        }
        x0 = x0 + s

        if (a>0 && abs(sg-p_sg)<eps) {
            if (phase=='prec') {
               f$found=TRUE
               f$mask = mm
               f$sigma = sg
               break;
            }
            phase='prec'
            print ('change phase')
            term_x=x0+step*2
            s=step
            x0=x0-s
            p_sg = 1e38
            next
        }
        p_sg = sg
    }
    if (f$found) {
        
    }
    f$x0 = x0
    f$A = a
    f$b = b
    f$fwhm = FWHM
    p_sg = 1e38
    if (f$found && fit_fwhm) {
       s = FWHM/8.0
       fwhm = FWHM
       print ('Fit fwhm')
       repeat {
           g = gauss(chan.nos,x0=x0, zc=0, A=1, sc=sc, fwhm=fwhm)
           fm = spectrum ~ g # + 0
           fw = lm (fm, weights = f$mask)
           cfs = fw$coefficients
           if (length(cfs)==2) { 
              a = cfs[2] 
              b = cfs[1]
           } else {
              a = cfs[1]
              b = 0
           }
           sm = summary(fw)
           sg = sm$sigma
           if (sg > p_sg) {
              s = -s/2.0
           }
           print (c(a, sg, p_sg, fwhm))
           if (abs(sg-p_sg)<eps) {
              f$fwhm = fwhm
              f$A = a
              f$b = b
              f$sigma = sg
              break
           }
           fwhm = fwhm + s
           p_sg = sg
       }
    }
    if (plot && f$found) {
        plot.xrf.spec(spectrum, f$x0, sc=SC)
        s = scaled.X(x0=x0, sc=sc)         
        g = gauss(chan.nos, f$x0, A=f$A, zc=0., sc=SC, fwhm=f$fwhm)+f$b
        lines(s, g, type='l')
        line.xrf.mark(0, spectrum, col='black')
        line.xrf.mark(6.4, spectrum)
    }
    f
}



DEBUG=FALSE
spectrum=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,6,8,18,44,77,134,251,446,780,1305,2090,3630,5551,8317,12908,19167,28124,40110,55577,75808,101195,133185,168936,211494,257773,308250,359943,412618,462019,505065,540157,568122,580990,583215,573783,551089,518898,478056,430586,380639,329631,279417,231064,188110,149661,117212,89269,66800,49948,35943,25300,17517,12161,8519,5636,3647,2455,1601,1066,693,514,365,265,193,190,166,119,122,110,99,91,81,72,64,60,62,68,74,62,47,38,33,43,31,21,17,22,35,88,113,120,135,125,111,106,120,125,166,170,280,574,1176,2230,3360,4256,4726,4721,4817,4743,4659,4722,4531,4565,4482,4516,4314,4276,4471,4419,4311,4312,4451,4289,4178,4244,4212,4169,4184,4133,4082,3927,4148,4016,4063,4006,4013,3881,3976,3913,3896,3910,3839,3885,3856,3934,3822,3757,3745,3863,3771,3851,3805,3823,3769,3732,3854,3701,3695,3683,3660,3687,3677,3692,3621,3644,3611,3490,3577,3540,3649,3595,3510,3563,3575,3490,3553,3627,3562,3531,3573,3524,3521,3497,3547,3461,3457,3360,3443,3540,3741,3586,3523,3513,3569,3523,3458,3373,3438,3530,3491,3541,3453,3454,3523,3351,3257,3357,3422,3403,3430,3383,3392,3450,3436,3297,3433,3385,3331,3282,3277,3327,3209,3160,3116,3163,3157,3092,3059,3032,3142,3069,3055,3080,3058,3000,2897,2875,2872,2866,2810,2806,2720,2785,2702,2643,2593,2671,2674,2598,2519,2583,2492,2441,2469,2563,2458,2416,2293,2301,2280,2164,2252,2186,2194,2094,2158,1978,2101,2076,2026,1978,1977,1971,2008,1931,1868,1948,1884,1874,1806,1798,1765,1739,1703,1675,1737,1692,1735,1729,1613,1545,1675,1575,1587,1632,1507,1521,1646,1539,1539,1448,1578,1463,1455,1435,1450,1458,1433,1403,1484,1448,1458,1482,1420,1463,1513,1481,1471,1542,1564,1575,1627,1660,1640,1692,1665,1752,1681,1770,1717,1776,1789,1830,1685,1730,1728,1684,1723,1678,1629,1642,1569,1554,1515,1551,1534,1537,1397,1522,1394,1425,1347,1383,1335,1301,1308,1290,1230,1333,1189,1222,1181,1172,1171,1191,1175,1185,1134,1146,1139,1096,1110,1055,1144,1157,1122,1135,1089,1055,1154,1099,1127,1135,1112,1128,1112,1138,1099,1117,1090,1092,1139,1161,1162,1119,1042,1149,1081,1080,1153,1134,1079,1118,1112,1045,1113,1146,1104,1143,1061,1092,1139,1079,1116,1107,1100,1082,1074,1123,1124,1127,1149,1040,1110,1153,1083,1101,1143,1122,1125,1076,1131,1211,1162,1170,1232,1233,1138,1215,1126,1138,1169,1135,1140,1148,1122,1162,1160,1143,1150,1124,1129,1096,1167,1083,1147,1087,1091,1082,1128,1061,1001,1046,1059,1057,1067,1003,1069,1084,1066,1092,1059,1081,1123,1139,1155,1196,1269,1272,1337,1444,1450,1512,1580,1708,1802,1843,1968,1998,2128,2182,2259,2294,2430,2292,2327,2357,2185,2284,2162,2108,2070,2024,1914,1835,1734,1614,1508,1466,1429,1319,1247,1244,1176,1101,1159,1080,1079,1106,1138,1103,1040,997,1058,1025,1043,1093,1017,1073,1052,972,1004,987,994,984,976,932,967,935,928,883,928,953,908,925,891,911,915,863,905,919,889,894,889,883,868,874,871,918,880,941,968,887,876,898,878,899,884,895,879,849,836,876,879,836,852,852,805,854,841,877,839,881,853,860,899,856,813,868,844,875,849,833,831,848,872,910,839,899,861,882,905,867,847,921,877,926,859,905,968,925,944,1017,1056,1016,1048,1023,1066,1127,1187,1149,1182,1196,1223,1269,1245,1256,1222,1167,1211,1121,1171,1072,1042,1086,1045,1044,1005,963,977,934,928,950,886,909,938,878,865,862,872,782,893,852,907,881,866,878,821,883,888,916,918,1010,939,979,994,1131,1173,1239,1386,1523,1619,1830,2082,2294,2636,3078,3373,3867,4498,5052,5669,6371,7134,7815,8758,9664,10458,11364,12192,12849,13617,14018,14528,15016,15193,15060,15075,14990,14570,14159,13489,12809,12363,11368,10543,9726,8796,7953,7291,6595,5671,5141,4486,3967,3571,2952,2624,2277,2008,1832,1622,1458,1319,1248,1111,1143,1104,1125,1114,1124,1148,1227,1222,1269,1318,1454,1506,1671,1738,1677,1929,2027,2126,2208,2359,2547,2544,2684,2725,2847,2901,3020,3150,3216,3248,3381,3465,3545,3519,3761,3857,3806,3876,4001,4041,4043,4102,4208,4135,4309,4140,4048,4057,3889,3908,3579,3622,3391,3154,2972,2864,2678,2483,2255,2137,1932,1716,1651,1455,1369,1261,1126,1125,1010,1012,917,847,805,811,815,804,746,767,748,777,753,700,772,690,706,718,726,718,743,736,803,747,754,823,835,840,866,869,880,946,978,967,920,1014,1056,1031,1042,1004,1025,988,1040,1005,1090,1052,1024,972,1010,1007,927,926,941,889,842,841,851,790,789,727,741,723,766,738,716,742,709,702,672,672,638,701,697,642,668,616,618,641,673,640,628,634,699,673,631,662,653,639,671,695,665,659,657,585,646,618,626,650,673,630,623,606,646,654,671,675,661,645,611,587,643,649,650,726,645,659,717,645,661,711,681,740,717,746,776,833,795,788,852,850,875,917,895,916,874,957,989,995,1077,1005,1026,990,1050,945,1021,1000,991,943,960,904,913,901,862,916,848,862,871,773,780,833,759,790,839,747,760,746,777,723,710,785,776,782,722,696,779,710,712,720,721,679,763,689,687,672,693,702,676,681,654,628,682,625,678,658,624,680,653,683,643,676,665,713,648,675,704,640,649,676,659,737,694,711,715,670,648,685,680,673,690,688,680,662,658,690,654,683,670,624,654,665,690,680,644,667,645,663,624,642,648,673,649,657,638,644,634,641,664,651,624,639,623,629,677,592,603,619,601,664,655,609,588,634,614,618,592,607,616,609,579,649,589,599,624,620,643,645,603,630,590,636,679,656,645,635,637,613,646,649,690,610,630,684,628,672,663,632,648,656,640,625,665,646,665,679,634,646,642,688,605,663,661,681,652,654,713,632,640,657,651,625,661,644,710,644,626,668,639,659,619,597,658,639,594,677,618,635,645,629,583,631,604,626,638,608,624,643,571,608,623,609,599,590,546,598,593,624,587,629,587,570,540,629,582,598,609,586,602,583,573,624,588,599,620,631,645,595,603,627,609,603,626,577,612,648,586,603,622,599,615,671,634,638,657,659,658,650,624,602,690,611,624,638,719,646,699,688,739,713,770,761,759,792,766,789,800,732,783,792,810,776,807,799,749,771,746,691,745,705,730,768,719,683,687,732,696,657,655,652,674,701,629,678,662,647,719,657,621,664,672,628,620,618,669,645,686,667,622,631,701,661,645,674,641,672,675,682,655,678,706,718,712,711,671,681,770,781,799,837,880,898,969,997,1160,1247,1339,1477,1713,1857,2085,2355,2687,2931,3468,3886,4324,4952,5658,6337,7142,8056,8755,9922,10810,12009,12817,13988,15170,16081,17251,18501,19347,20240,21230,21991,22372,23128,23487,23796,23795,23514,23490,22899,22578,22023,21478,20424,19495,18580,17219,16345,15280,14166,12979,11905,10707,9945,8785,8122,7272,6412,5590,4963,4496,3834,3290,3002,2515,2290,2020,1772,1534,1390,1265,1087,1028,965,904,844,760,757,690,721,669,642,668,621,640,662,589,597,588,613,588,590,599,577,611,629,581,599,629,560,656,599,590,587,581,603,607,577,617,575,590,587,620,579,553,593,641,631,595,598,635,654,599,626,672,642,679,682,612,674,738,746,710,768,788,822,834,901,913,907,985,1096,1100,1151,1325,1288,1506,1607,1652,1730,1902,2011,2184,2352,2537,2546,2609,2869,2905,3064,3123,3281,3303,3418,3527,3442,3528,3480,3552,3553,3470,3363,3304,3259,3123,3038,2880,2674,2682,2543,2261,2201,2223,1963,1814,1739,1602,1501,1432,1345,1132,1166,1110,982,913,865,802,754,776,735,658,660,586,596,578,574,584,599,536,636,518,532,568,526,566,498,525,600,589,543,542,582,550,553,548,538,549,545,581,582,571,569,553,623,562,614,562,598,603,621,603,604,593,621,651,602,584,571,632,594,617,631,646,610,589,614,596,587,575,575,570,538,613,594,571,546,569,553,555,580,546,586,541,540,522,551,536,545,530,497,512,548,516,535,509,523,529,533,512,482,507,520,537,547,551,507,562,522,527,566,484,517,544,584,521,564,562,550,536,510,534,533,512,537,536,525,563,548,510,546,518,541,565,563,550,521,548,555,551,537,577,543,584,586,542,598,614,605,572,572,555,581,585,566,561,591,557,564,615,629,581,586,617,666,592,578,649,654,649,702,624,660,683,647,665,655,607,600,657,649,612,673,612,613,635,651,603,612,616,611,609,543,605,565,582,563,585,604,616,531,559,543,543,540,545,554,531,507,564,542,537,531,536,515,573,546,544,579,559,545,571,493,596,546,612,588,543,520,511,528,510,578,555,590,590,562,541,535,614,555,565,544,540,564,547,547,547,581,527,533,594,572,552,558,577,601,566,586,540,536,593,560,590,596,518,618,610,574,624,617,616,620,639,645,691,714,719,731,750,746,713,782,801,831,811,802,799,815,821,855,770,822,837,789,810,850,914,804,825,810,797,808,752,789,777,738,760,696,653,648,664,663,685,713,623,586,598,608,588,629,611,557,581,569,602,583,577,564,534,508,539,562,545,500,540,560,550,577,533,519,523,559,542,563,548,525,515,552,572,563,557,539,618,592,575,551,518,585,591,522,572,570,562,567,538,578,589,578,523,524,582,537,527,548,571,571,556,584,516,593,620,558,560,582,535,548,597,542,599,542,567,615,553,632,606,607,646,629,611,603,633,579,614,658,658,663,610,661,669,645,670,714,631,685,684,643,670,718,656,629,653,644,627,669,628,647,621,632,652,596,616,637,620,629,589,638,545,569,580,563,535,601,539,579,549,568,553,536,582,558,534,573,571,513,580,561,579,620,561,570,581,606,547,551,621,550,591,581,595,602,591,626,552,585,601,521,615,581,588,612,612,597,568,541,577,595,583,548,588,580,598,595,563,569,565,590,565,581,605,584,639,578,580,597,570,547,566,554,607,593,556,562,596,559,602,576,540,567,527,525,544,545,553,547,554,529,563,533,573,576,545,567,523,573,560,554,516,579,584,602,550,574,556,556,554,543,538,575,580,544,542,586,563,541,604,576,606,565,544,550,560,555,557,564,538,562,578,553,548,538,548,554,506,575,547,572,556,608,522,582,544,574,565,545,557,587,563,591,548,569,554,614,531,617,543,561,579,550,581,617,590,603,569,613,557,506,549,580,574,592,613,597,572,602,621,600,586,574,566,596,596,561,605,619,583,611,593,639,545,622,595,601,538,589,591,649,583,614,592,633,582,581,579,619,650,650,641,639,618,639,644,685,663,665,738,670,704,706,743,774,736,728,815,750,771,771,807,781,753,820,775,819,840,820,804,786,828,841,821,783,859,827,741,770,729,768,746,807,810,719,758,713,676,675,696,673,664,668,657,674,677,632,624,623,675,608,595,630,591,637,597,604,638,610,605,583,572,629,559,630,604,601,606,598,624,644,586,617,593,611,602,605,561,619,586,607,571,602,577,604,639,652,615,603,564,556,601,582,615,600,577,579,620,588,606,560,573,616,582,607,603,638,595,604,618,603,593,576,583,571,597,613,628,636,615,556,642,637,612,601,583,606,589,579,609,612,579,622,608,623,648,652,634,593,646,601,630,579,620,627,603,646,617,616,641,611,627,598,638,581,615,595,632,602,612,588,619,575,587,632,630,603,622,659,601,624,558,602,620,569,597,691,589,622,641,616,621,626,592,599,609,604,635,594,571,677,571,645,585,632,619,671,605,663,612,619,632,633,616,674,624,621,604,663,627,634,605,653,616,576,627,622,661,640,627,627,664,612,662,648,608,676,629,630,617,631,645,618,652,652,673,623,637,682,660,617,627,636,624,657,650,625,699,661,642,650,663,655,623,661,660,650,634,645,618,619,609,653,627,688,690,618,653,668,664,615,645,591,630,658,609,624,682,649,644,623,687,651,652,671,642,691,655,675,687,640,678,703,662,686,658,690,654,698,674,673,656,665,685,699,687,658,701,640,643,666,696,668,685,666,678,648,696,698,658,652,704,680,651,664,674,715,664,682,646,677,716,688,648,683,697,684,650,682,659,724,735,717,675,682,683,729,686,651,695,699,693,651,668,720,700,749,703,770,676,682,708,686,711,691,691,723,721,732,716,730,720,744,677,717,702,688,699,711,679,705,734,702,776,731,768,719,714,713,702,760,677,726,694,757,741,699,746,746,702,790,776,769,816,779,771,783,796,765,795,810,837,827,869,861,876,851,838,939,852,915,867,931,933,943,911,953,922,941,962,950,978,943,953,993,971,957,911,976,908,931,964,931,953,929,920,926,929,880,893,992,848,899,818,891,827,864,834,853,824,884,901,807,834,815,867,839,867,857,853,814,911,808,871,843,819,859,891,824,820,850,909,923,866,936,888,876,900,935,856,880,930,939,963,951,936,943,952,933,936,919,878,948,890,949,915,975,958,922,924,918,945,977,890,1035,913,898,912,891,878,911,905,924,947,920,887,928,978,967,922,893,906,937,963,963,936,942,945,977,960,964,999,1076,1017,1033,1086,1103,1070,1167,1184,1205,1270,1380,1408,1500,1464,1556,1588,1678,1638,1824,1746,1922,1949,2033,2143,2120,2397,2318,2423,2535,2559,2550,2632,2722,2733,2827,2864,2926,2860,2988,2953,3105,3115,3041,2977,2947,2983,2866,2925,2813,2864,2841,2668,2631,2638,2578,2481,2429,2390,2283,2219,2150,1981,1976,1934,1902,1867,1689,1717,1612,1593,1656,1490,1428,1374,1440,1394,1299,1245,1249,1226,1222,1212,1168,1204,1192,1224,1141,1193,1081,1156,1081,1140,1100,1096,1108,1082,1096,1098,1134,1086,1156,1121,1038,1157,1129,1156,1106,1088,1116,1091,1108,1142,1154,1188,1142,1129,1136,1181,1167,1120,1174,1156,1206,1177,1187,1184,1173,1213,1270,1271,1251,1193,1285,1214,1218,1191,1259,1212,1259,1232,1245,1230,1217,1259,1268,1273,1259,1227,1254,1299,1239,1346,1309,1290,1361,1304,1358,1285,1329,1373,1372,1316,1374,1318,1396,1428,1365,1411,1439,1425,1420,1467,1501,1457,1460,1475,1456,1557,1455,1568,1486,1601,1496,1577,1547,1565,1558,1571,1547,1639,1590,1624,1546,1634,1623,1733,1568,1682,1684,1680,1677,1703,1734,1668,1713,1697,1727,1689,1739,1673,1729,1676,1817,1676,1671,1797,1706,1718,1775,1772,1732,1786,1740,1789,1847,1749,1829,1868,1876,1806,1894,1802,1867,1850,1957,1945,1864,1868,1881,1940,1929,1956,1957,1943,1974,2028,1945,1946,2020,1992,2043,2114,2032,2088,1997,2120,2061,2087,2205,2180,2182,2201,2231,2305,2236,2175,2270,2275,2326,2229,2275,2300,2341,2378,2363,2398,2401,2454,2409,2455,2543,2489,2566,2492,2528,2586,2537,2584,2488,2504,2567,2648,2602,2602,2685,2688,2705,2747,2790,2876,2758,2897,2895,2959,2959,2998,2988,3046,3102,3013,3180,3074,3110,3261,3167,3210,3319,3258,3463,3375,3436,3473,3377,3541,3520,3653,3688,3847,3763,3871,3882,3897,4068,4132,3954,4088,4159,4219,4230,4231,4456,4472,4474,4615,4506,4677,4588,4757,4604,4878,4777,4860,4952,5028,4954,5038,5096,5283,5171,5254,5120,5039,5193,5331,5207,5307,5205,5285,5305,5450,5550,5420,5404,5369,5465,5469,5414,5399,5493,5430,5711,5524,5537,5731,5685,5698,5804,5749,5878,5916,5841,5836,5928,6042,5985,5991,6143,6330,6340,6291,6192,6427,6492,6572,6622,6820,6861,6787,6795,7074,7096,7107,7058,7254,7151,7422,7496,7540,7539,7623,7692,7964,7905,7973,8095,8188,8115,8276,8324,8349,8521,8525,8866,8784,9048,8952,9097,9226,9299,9268,9354,9542,9490,9734,9740,9708,9995,10241,10137,10323,10349,10531,10649,10616,10973,10857,11151,11163,11301,11247,11541,11453,11290,11758,12101,11963,12168,12274,12661,12402,12786,12994,12797,13066,13085,13185,13532,13578,13563,13969,13781,14345,14075,14406,14453,14725,14818,14791,14927,15109,15131,15470,15743,15843,16021,16287,16323,16586,16660,16742,16914,17080,17170,17369,17537,17455,17850,17863,18010,18257,18486,18784,18855,19004,18809,19449,19389,19535,19691,19823,19716,20196,20268,20478,20925,20830,21083,21543,21595,21621,21705,21943,22266,22563,22658,22722,22951,23081,23409,23530,23887,23857,24260,24779,24681,24804,25324,25620,25701,25923,26099,26902,26927,27024,27563,27274,28035,28361,28945,28942,29693,29632,30208,29990,30715,31118,32005,31965,31997,33028,33245,34178,34305,34574,35589,35830,36245,37126,37635,38144,38559,39320,40044,40610,41160,41579,42688,43362,44219,45013,45641,47063,47046,47704,49005,49695,50540,51431,52589,53533,54676,55518,56442,58134,58817,60014,61124,62244,63971,64567,65921,67084,68381,69049,70697,72055,73392,75323,76000,77758,79227,80774,82379,83910,85415,86904,87970,89934,90774,93068,94541,95935,98232,99468,100881,103055,104657,106974,108004,110190,111589,113800,115496,117194,118457,120411,122105,123733,125345,127428,128916,131559,132847,134329,136433,137960,139627,140679,143269,145205,145829,147921,149104,150983,152689,154474,156343,157395,159163,160924,162010,163709,165204,167151,167551,169622,170741,172575,173809,174441,176441,177350,178874,180280,181714,181927,183639,185404,185541,186759,187859,188824,189791,190773,191821,192541,192903,194324,194984,195776,197030,198176,197641,198717,200022,200489,201723,201939,201678,202932,203642,204403,204608,205344,206584,206685,206513,207119,206981,209196,207937,209465,209067,209286,209766,209542,210203,211471,210925,211471,212248,211355,212158,213056,212103,213134,212606,212441,213455,213359,213920,213655,213760,213441,214272,215500,214558,214259,214245,215526,216047,215040,215831,215569,215992,215332,215686,215935,216213,216284,215815,216760,216983,216345,215708,216177,217213,216166,215884,215823,216758,217132,217353,216497,215533,216458,214909,215056,215603,215939,215032,214662,215974,214802,214801,215202,214037,213364,213182,213178,212988,213367,212778,212750,212948,212418,211988,212210,212275,211195,211904,212560,213511,212642,212146,212739,213437,214390,214636,216221,217603,218057,219549,221346,221785,223794,225919,227471,229094,230770,232741,235747,237126,240123,242858,244978,248461,251143,252204,255678,258130,261171,264916,266728,268823,270992,273927,275303,277318,279870,281043,282984,283514,283703,285923,285005,284887,284537,284216,283815,282147,279550,279261,275314,272898,269655,265386,261513,257416,253136,248602,242831,236796,230545,225052,217850,211898,204368,198219,189950,183427,176131,168236,160348,153340,145237,137953,131802,124134,117085,110732,103905,97498,91229,85516,79919,74018,69201,64134,59334,55036,50694,46849,43031,40029,36763,33644,31010,28772,26132,24072,22019,20759,18665,17518,16132,14817,13817,12832,11993,11255,10586,9785,9238,8746,8106,7796,7512,7046,6644,6415,6325,6068,5812,5549,5471,5179,5147,5121,4898,4664,4739,4493,4361,4246,4253,4228,4113,3921,3772,3817,3754,3561,3549,3442,3392,3345,3195,3211,3154,3083,3027,2907,2857,2935,2768,2743,2690,2673,2576,2556,2443,2405,2361,2334,2250,2273,2121,2209,2120,2040,2048,1954,1935,1876,1942,1834,1753,1776,1693,1662,1668,1625,1614,1529,1506,1447,1495,1451,1418,1357,1392,1394,1263,1271,1295,1263,1196,1163,1146,1160,1131,1061,1073,1066,1105,1012,987,1012,1036,928,924,981,909,920,914,830,897,806,855,800,729,796,806,781,747,738,762,739,681,706,686,676,678,720,601,638,639,574,659,640,608,619,580,556,553,566,562,565,546,506,537,574,520,528,560,527,532,493,507,544,499,478,502,466,510,443,452,497,424,446,454,425,449,426,409,449,401,430,424,420,379,399,397,416,381,401,386,368,374,383,358,394,363,371,378,444,338,406,329,359,370,369,329,345,357,341,336,362,378,322,344,366,315,340,315,330,370,345,333,317,323,323,283,326,316,323,273,286,320,296,311,325,290,293,303,317,288,314,321,299,291,291,268,272,288,294,324,308,262,275,287,287,258,289,258,276,260,265,293,290,293,285,267,258,244,280,286,273,264,257,245,236,262,268,238,258,263,231,248,249,256,228,224,244,236,248,237,231,240,279,218,242,238,223,223,238,225,236,216,253,242,205,226,223,246,248,210,233,241,240,242,223,201,215,228,189,220,210,203,200,191,213,226,194,225,224,202,196,196,206,199,199,196,170,193,185,173,208,200,200,204,202,209,181,193,183,162,202,175,177,200,187,198,190,221,180,196,198,202,224,221,206,225,204,209,229,243,229,226,231,239,232,238,238,201,209,233,256,235,243,220,242,233,257,237,202,227,244,217,195,199,216,214,209,181,179,191,177,193,172,166,131,158,147,138,130,132,122,110,126,122,135,111,94,104,93,103,102,92,71,74,82,77,81,76,95,77,73,75,77,76,75,79,80,63,68,65,55,71,76,65,65,70,72,69,61,75,65,59,76,56,64,60,73,76,68,68,66,67,79,75,62,65,70,56,72,69,68)

# plot(ch, A, type="l")

png('plot.png', width=1280, height=1024)

fit0=find_pike(97, spectrum, plot=FALSE)
x0=fit0$x0
ch.Fe = 6.4/SC + x0
fit.Fe=find_pike(ch.Fe, spectrum, plot=TRUE)
if (DEBUG) {
    plot(spectrum, type='l')
    line.xrf.mark(ch.Fe, spectrum)
}
x0.Fe=fit.Fe$x0

dev.off()

print (ch.Fe)
print (x0.Fe)

