source('global.R')

#STEP=FWHM/4.0/sc

scaled.X=function (x0=0, sc=1) {
        s = chan.nos - x0
        s = s * SC
        s
}

#scaled.channels(X0=0,)

plot.xrf.spec = function (spectrum, x0=0, sc=1, col='red') {
        s = scaled.X(x0=x0, sc=sc)         
        plot(s, spectrum, type='l', col=col) 
}

line.xrf.mark = function(ev, spectrum, col='green', scale='channels') {
        if (scale=='channels') {
                lines(c(ev, ev), c(0,max(spectrum)/2.), col=col)
        } else {
                ch = ev/SC
                ch = ch+x0
                line.xrf.mark(ch, spectrum, col=col, scale='channels')
        };
}

find_pike1 = function (start_x0=97, spectrum, step=STEP, channels=3*FWHM/sc, eps=1.0, plot=FALSE, fit_fwhm=TRUE) {
    x0 = start_x0 - as.integer(channels/2.0)
    term_x = x0 + channels
    p_sg = 1e38
    s = step
    f = list()
    phase = 'raw'
    # scanning the interval of channels around start_x0
    repeat {
        if (x0>term_x) {
           f$found=FALSE
           break;
        }
        g = gauss(chan.nos,x0=x0, zc=0, A=1, sc=sc)
        if (phase=='prec') {
           mm = mask(g, level=0.001)
           fm = spectrum ~ g + 0
        } else {
           mm = 0
           fm = spectrum ~ g
        }
        f = lm(fm, weights=mm)
        cfs = f$coefficients
        if (length(cfs)==2) { 
           a = cfs[2] 
           b = cfs[1]
        } else {
           a = cfs[1]
           b = 0
        }

        sm = summary(f)
        sg = sm$sigma
        print (c(a, sg, x0, s, b))
        if ((b>=0 || phase=='prec') && a>0){ 
           if (sg > p_sg)
              s = -s/2.0
        }
        x0 = x0 + s

        if (a>0 && abs(sg-p_sg)<eps) {
            if (phase=='prec') {
               f$found=TRUE
               f$mask = mm
               f$sigma = sg
               break;
            }
            phase='prec'
            print ('change phase')
            term_x=x0+step*2
            s=step
            x0=x0-s
            p_sg = 1e38
            next
        }
        p_sg = sg
    }
    if (f$found){
    }
    f$x0 = x0
    f$A = a
    f$b = b
    f$fwhm = FWHM
    p_sg = 1e38
    if (f$found && fit_fwhm) {
       s = FWHM/8.0
       fwhm = FWHM
       print ('Fit fwhm')
       repeat {
           g = gauss(chan.nos,x0=x0, zc=0, A=1.0, sc=sc, fwhm=fwhm)
           fm = spectrum ~ g # + 0
           fw = lm (fm, weights = f$mask)
           cfs = fw$coefficients
           if (length(cfs)==2) { 
              a = cfs[2] 
              b = cfs[1]
           } else {
              a = cfs[1]
              b = 0
           }
           sm = summary(fw)
           sg = sm$sigma
           if (sg > p_sg) {
              s = -s/2.0
           }
           print (c(a, sg, p_sg, fwhm))
           if (abs(sg-p_sg)<eps) {
              f$fwhm = fwhm
              f$A = a
              f$b = b
              f$sigma = sg
              break
           }
           fwhm = fwhm + s
           p_sg = sg
       }
    }
    if (plot && f$found) {
        plot.xrf.spec(spectrum, f$x0, sc=SC)
        s=scaled.X(x0=x0, sc=SC)
        g=gauss(X, f$x0, A=f$A, zc=0., sc=SC, fwhm=FWHM)+f$b
        lines(s, g, type = 'l')
        line.xrf.mark(0, spectrum, col = 'red')
        line.xrf.mark(6.4 ,spectrum)
    }
    f
}

sq2pi=sqrt(2*pi)

sim_gauss = function(x, x0, A, fwhm=FWHM) {
        sigma = (fwhm / 2.35482)
        A * sq2pi * exp(-((x-x0)**2/(2*sigma**2)))
};

DEBUG = 5

x0_gauss=function(x0, A, xi, params) {
    FWHM=params$fwhm
    sim_gauss(x=xi, x0=x0, A=A, fwhm=FWHM)
}

fwhm_gauss=function(fwhm, A, xi, params) {
    x0=params$x0
    sim_gauss(x=xi, x0=x0, A=A, fwhm=fwhm)
}

gauss_stru=function(r){
   #X=r$X
   x0=r$x0
   A=r$A
   fwhm=r$fwhm
   sim_gauss(x0,X,A,fwhm)
}
Com=function(X, x0_star=97, E){
      sig = (fwhm / 2.35482)
      };
            
find_pike = function(spec, fun, x, A, xmin=1, xmax=NULL, eps, params=list()) {
    lspec=length(spec)
    if (is.null(xmax)) xmax=lspec
    if (xmin<1) xmin=1
    if (x<=xmin) x=xmin;
    if (x>=xmax) x=xmax;
    
    X=1:lspec - 0.5
    
    interv = spec[xmin:xmax]
    xi = 1:((xmax-xmin)+1)
    
    x_ = which.max(interv)
    x_scan = x_ + xmin - 1
    
    A = interv[x_]
    
    if (DEBUG > 10) {
        print (A == spec[x_scan])
    }

    # find parameters of gaussian line
    #dx0 = (xmax-xmin) / 2.
    dx=1
    x=x-xmin+1
    #x0=1
    x=x_
    vp=NaN
    xp=NaN
    i=1
    xmi=1
    xma=length(interv)
    repeat {
	#print (c("x,dx,vp,i, A", x, dx, vp, i, A))
	g = fun(x, A, xi, params=params)
	#print(g)
	m=lm(interv ~ g)
	v = sum(m$residuals**2)
	#print(c("s,v",summary(m), v))
	GO_MIN=FALSE
	if (! is.nan(vp)) {
	    dv=v-vp
	    #print (c("v,vp", v,vp))
	    if (abs(dv) < eps) break;
	    if (vp < v) {
		x=xp
		dx = -dx/2.
		x=x+dx
	    } else {
		x=x+dx
		GO_MIN=TRUE
	    }
	} else {
	   x=x+dx
	}
	if (GO_MIN && (x>=xmi || x<=xma)) {
	    if (x>=xma) x=xma;
	    if (x<=xmi) x=xmi;
	    dx=x-xp
	}
	vp=v
	xp=x
	cs=m$coefficients
	#print(summary(m))
	i=i+1
    }
    A=A*cs[length(cs)]
    l=list()
    l$x=x+xmin-1
    l$A=A
    l$lm=m
    l$variance=v
    l$X=xi
    l
};


#spectrum=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,2,6,8,18,44,77,134,251,446,780,1305,2090,3630,5551,8317,12908,19167,28124,40110,55577,75808,101195,133185,168936,211494,257773,308250,359943,412618,462019,505065,540157,568122,580990,583215,573783,551089,518898,478056,430586,380639,329631,279417,231064,188110,149661,117212,89269,66800,49948,35943,25300,17517,12161,8519,5636,3647,2455,1601,1066,693,514,365,265,193,190,166,119,122,110,99,91,81,72,64,60,62,68,74,62,47,38,33,43,31,21,17,22,35,88,113,120,135,125,111,106,120,125,166,170,280,574,1176,2230,3360,4256,4726,4721,4817,4743,4659,4722,4531,4565,4482,4516,4314,4276,4471,4419,4311,4312,4451,4289,4178,4244,4212,4169,4184,4133,4082,3927,4148,4016,4063,4006,4013,3881,3976,3913,3896,3910,3839,3885,3856,3934,3822,3757,3745,3863,3771,3851,3805,3823,3769,3732,3854,3701,3695,3683,3660,3687,3677,3692,3621,3644,3611,3490,3577,3540,3649,3595,3510,3563,3575,3490,3553,3627,3562,3531,3573,3524,3521,3497,3547,3461,3457,3360,3443,3540,3741,3586,3523,3513,3569,3523,3458,3373,3438,3530,3491,3541,3453,3454,3523,3351,3257,3357,3422,3403,3430,3383,3392,3450,3436,3297,3433,3385,3331,3282,3277,3327,3209,3160,3116,3163,3157,3092,3059,3032,3142,3069,3055,3080,3058,3000,2897,2875,2872,2866,2810,2806,2720,2785,2702,2643,2593,2671,2674,2598,2519,2583,2492,2441,2469,2563,2458,2416,2293,2301,2280,2164,2252,2186,2194,2094,2158,1978,2101,2076,2026,1978,1977,1971,2008,1931,1868,1948,1884,1874,1806,1798,1765,1739,1703,1675,1737,1692,1735,1729,1613,1545,1675,1575,1587,1632,1507,1521,1646,1539,1539,1448,1578,1463,1455,1435,1450,1458,1433,1403,1484,1448,1458,1482,1420,1463,1513,1481,1471,1542,1564,1575,1627,1660,1640,1692,1665,1752,1681,1770,1717,1776,1789,1830,1685,1730,1728,1684,1723,1678,1629,1642,1569,1554,1515,1551,1534,1537,1397,1522,1394,1425,1347,1383,1335,1301,1308,1290,1230,1333,1189,1222,1181,1172,1171,1191,1175,1185,1134,1146,1139,1096,1110,1055,1144,1157,1122,1135,1089,1055,1154,1099,1127,1135,1112,1128,1112,1138,1099,1117,1090,1092,1139,1161,1162,1119,1042,1149,1081,1080,1153,1134,1079,1118,1112,1045,1113,1146,1104,1143,1061,1092,1139,1079,1116,1107,1100,1082,1074,1123,1124,1127,1149,1040,1110,1153,1083,1101,1143,1122,1125,1076,1131,1211,1162,1170,1232,1233,1138,1215,1126,1138,1169,1135,1140,1148,1122,1162,1160,1143,1150,1124,1129,1096,1167,1083,1147,1087,1091,1082,1128,1061,1001,1046,1059,1057,1067,1003,1069,1084,1066,1092,1059,1081,1123,1139,1155,1196,1269,1272,1337,1444,1450,1512,1580,1708,1802,1843,1968,1998,2128,2182,2259,2294,2430,2292,2327,2357,2185,2284,2162,2108,2070,2024,1914,1835,1734,1614,1508,1466,1429,1319,1247,1244,1176,1101,1159,1080,1079,1106,1138,1103,1040,997,1058,1025,1043,1093,1017,1073,1052,972,1004,987,994,984,976,932,967,935,928,883,928,953,908,925,891,911,915,863,905,919,889,894,889,883,868,874,871,918,880,941,968,887,876,898,878,899,884,895,879,849,836,876,879,836,852,852,805,854,841,877,839,881,853,860,899,856,813,868,844,875,849,833,831,848,872,910,839,899,861,882,905,867,847,921,877,926,859,905,968,925,944,1017,1056,1016,1048,1023,1066,1127,1187,1149,1182,1196,1223,1269,1245,1256,1222,1167,1211,1121,1171,1072,1042,1086,1045,1044,1005,963,977,934,928,950,886,909,938,878,865,862,872,782,893,852,907,881,866,878,821,883,888,916,918,1010,939,979,994,1131,1173,1239,1386,1523,1619,1830,2082,2294,2636,3078,3373,3867,4498,5052,5669,6371,7134,7815,8758,9664,10458,11364,12192,12849,13617,14018,14528,15016,15193,15060,15075,14990,14570,14159,13489,12809,12363,11368,10543,9726,8796,7953,7291,6595,5671,5141,4486,3967,3571,2952,2624,2277,2008,1832,1622,1458,1319,1248,1111,1143,1104,1125,1114,1124,1148,1227,1222,1269,1318,1454,1506,1671,1738,1677,1929,2027,2126,2208,2359,2547,2544,2684,2725,2847,2901,3020,3150,3216,3248,3381,3465,3545,3519,3761,3857,3806,3876,4001,4041,4043,4102,4208,4135,4309,4140,4048,4057,3889,3908,3579,3622,3391,3154,2972,2864,2678,2483,2255,2137,1932,1716,1651,1455,1369,1261,1126,1125,1010,1012,917,847,805,811,815,804,746,767,748,777,753,700,772,690,706,718,726,718,743,736,803,747,754,823,835,840,866,869,880,946,978,967,920,1014,1056,1031,1042,1004,1025,988,1040,1005,1090,1052,1024,972,1010,1007,927,926,941,889,842,841,851,790,789,727,741,723,766,738,716,742,709,702,672,672,638,701,697,642,668,616,618,641,673,640,628,634,699,673,631,662,653,639,671,695,665,659,657,585,646,618,626,650,673,630,623,606,646,654,671,675,661,645,611,587,643,649,650,726,645,659,717,645,661,711,681,740,717,746,776,833,795,788,852,850,875,917,895,916,874,957,989,995,1077,1005,1026,990,1050,945,1021,1000,991,943,960,904,913,901,862,916,848,862,871,773,780,833,759,790,839,747,760,746,777,723,710,785,776,782,722,696,779,710,712,720,721,679,763,689,687,672,693,702,676,681,654,628,682,625,678,658,624,680,653,683,643,676,665,713,648,675,704,640,649,676,659,737,694,711,715,670,648,685,680,673,690,688,680,662,658,690,654,683,670,624,654,665,690,680,644,667,645,663,624,642,648,673,649,657,638,644,634,641,664,651,624,639,623,629,677,592,603,619,601,664,655,609,588,634,614,618,592,607,616,609,579,649,589,599,624,620,643,645,603,630,590,636,679,656,645,635,637,613,646,649,690,610,630,684,628,672,663,632,648,656,640,625,665,646,665,679,634,646,642,688,605,663,661,681,652,654,713,632,640,657,651,625,661,644,710,644,626,668,639,659,619,597,658,639,594,677,618,635,645,629,583,631,604,626,638,608,624,643,571,608,623,609,599,590,546,598,593,624,587,629,587,570,540,629,582,598,609,586,602,583,573,624,588,599,620,631,645,595,603,627,609,603,626,577,612,648,586,603,622,599,615,671,634,638,657,659,658,650,624,602,690,611,624,638,719,646,699,688,739,713,770,761,759,792,766,789,800,732,783,792,810,776,807,799,749,771,746,691,745,705,730,768,719,683,687,732,696,657,655,652,674,701,629,678,662,647,719,657,621,664,672,628,620,618,669,645,686,667,622,631,701,661,645,674,641,672,675,682,655,678,706,718,712,711,671,681,770,781,799,837,880,898,969,997,1160,1247,1339,1477,1713,1857,2085,2355,2687,2931,3468,3886,4324,4952,5658,6337,7142,8056,8755,9922,10810,12009,12817,13988,15170,16081,17251,18501,19347,20240,21230,21991,22372,23128,23487,23796,23795,23514,23490,22899,22578,22023,21478,20424,19495,18580,17219,16345,15280,14166,12979,11905,10707,9945,8785,8122,7272,6412,5590,4963,4496,3834,3290,3002,2515,2290,2020,1772,1534,1390,1265,1087,1028,965,904,844,760,757,690,721,669,642,668,621,640,662,589,597,588,613,588,590,599,577,611,629,581,599,629,560,656,599,590,587,581,603,607,577,617,575,590,587,620,579,553,593,641,631,595,598,635,654,599,626,672,642,679,682,612,674,738,746,710,768,788,822,834,901,913,907,985,1096,1100,1151,1325,1288,1506,1607,1652,1730,1902,2011,2184,2352,2537,2546,2609,2869,2905,3064,3123,3281,3303,3418,3527,3442,3528,3480,3552,3553,3470,3363,3304,3259,3123,3038,2880,2674,2682,2543,2261,2201,2223,1963,1814,1739,1602,1501,1432,1345,1132,1166,1110,982,913,865,802,754,776,735,658,660,586,596,578,574,584,599,536,636,518,532,568,526,566,498,525,600,589,543,542,582,550,553,548,538,549,545,581,582,571,569,553,623,562,614,562,598,603,621,603,604,593,621,651,602,584,571,632,594,617,631,646,610,589,614,596,587,575,575,570,538,613,594,571,546,569,553,555,580,546,586,541,540,522,551,536,545,530,497,512,548,516,535,509,523,529,533,512,482,507,520,537,547,551,507,562,522,527,566,484,517,544,584,521,564,562,550,536,510,534,533,512,537,536,525,563,548,510,546,518,541,565,563,550,521,548,555,551,537,577,543,584,586,542,598,614,605,572,572,555,581,585,566,561,591,557,564,615,629,581,586,617,666,592,578,649,654,649,702,624,660,683,647,665,655,607,600,657,649,612,673,612,613,635,651,603,612,616,611,609,543,605,565,582,563,585,604,616,531,559,543,543,540,545,554,531,507,564,542,537,531,536,515,573,546,544,579,559,545,571,493,596,546,612,588,543,520,511,528,510,578,555,590,590,562,541,535,614,555,565,544,540,564,547,547,547,581,527,533,594,572,552,558,577,601,566,586,540,536,593,560,590,596,518,618,610,574,624,617,616,620,639,645,691,714,719,731,750,746,713,782,801,831,811,802,799,815,821,855,770,822,837,789,810,850,914,804,825,810,797,808,752,789,777,738,760,696,653,648,664,663,685,713,623,586,598,608,588,629,611,557,581,569,602,583,577,564,534,508,539,562,545,500,540,560,550,577,533,519,523,559,542,563,548,525,515,552,572,563,557,539,618,592,575,551,518,585,591,522,572,570,562,567,538,578,589,578,523,524,582,537,527,548,571,571,556,584,516,593,620,558,560,582,535,548,597,542,599,542,567,615,553,632,606,607,646,629,611,603,633,579,614,658,658,663,610,661,669,645,670,714,631,685,684,643,670,718,656,629,653,644,627,669,628,647,621,632,652,596,616,637,620,629,589,638,545,569,580,563,535,601,539,579,549,568,553,536,582,558,534,573,571,513,580,561,579,620,561,570,581,606,547,551,621,550,591,581,595,602,591,626,552,585,601,521,615,581,588,612,612,597,568,541,577,595,583,548,588,580,598,595,563,569,565,590,565,581,605,584,639,578,580,597,570,547,566,554,607,593,556,562,596,559,602,576,540,567,527,525,544,545,553,547,554,529,563,533,573,576,545,567,523,573,560,554,516,579,584,602,550,574,556,556,554,543,538,575,580,544,542,586,563,541,604,576,606,565,544,550,560,555,557,564,538,562,578,553,548,538,548,554,506,575,547,572,556,608,522,582,544,574,565,545,557,587,563,591,548,569,554,614,531,617,543,561,579,550,581,617,590,603,569,613,557,506,549,580,574,592,613,597,572,602,621,600,586,574,566,596,596,561,605,619,583,611,593,639,545,622,595,601,538,589,591,649,583,614,592,633,582,581,579,619,650,650,641,639,618,639,644,685,663,665,738,670,704,706,743,774,736,728,815,750,771,771,807,781,753,820,775,819,840,820,804,786,828,841,821,783,859,827,741,770,729,768,746,807,810,719,758,713,676,675,696,673,664,668,657,674,677,632,624,623,675,608,595,630,591,637,597,604,638,610,605,583,572,629,559,630,604,601,606,598,624,644,586,617,593,611,602,605,561,619,586,607,571,602,577,604,639,652,615,603,564,556,601,582,615,600,577,579,620,588,606,560,573,616,582,607,603,638,595,604,618,603,593,576,583,571,597,613,628,636,615,556,642,637,612,601,583,606,589,579,609,612,579,622,608,623,648,652,634,593,646,601,630,579,620,627,603,646,617,616,641,611,627,598,638,581,615,595,632,602,612,588,619,575,587,632,630,603,622,659,601,624,558,602,620,569,597,691,589,622,641,616,621,626,592,599,609,604,635,594,571,677,571,645,585,632,619,671,605,663,612,619,632,633,616,674,624,621,604,663,627,634,605,653,616,576,627,622,661,640,627,627,664,612,662,648,608,676,629,630,617,631,645,618,652,652,673,623,637,682,660,617,627,636,624,657,650,625,699,661,642,650,663,655,623,661,660,650,634,645,618,619,609,653,627,688,690,618,653,668,664,615,645,591,630,658,609,624,682,649,644,623,687,651,652,671,642,691,655,675,687,640,678,703,662,686,658,690,654,698,674,673,656,665,685,699,687,658,701,640,643,666,696,668,685,666,678,648,696,698,658,652,704,680,651,664,674,715,664,682,646,677,716,688,648,683,697,684,650,682,659,724,735,717,675,682,683,729,686,651,695,699,693,651,668,720,700,749,703,770,676,682,708,686,711,691,691,723,721,732,716,730,720,744,677,717,702,688,699,711,679,705,734,702,776,731,768,719,714,713,702,760,677,726,694,757,741,699,746,746,702,790,776,769,816,779,771,783,796,765,795,810,837,827,869,861,876,851,838,939,852,915,867,931,933,943,911,953,922,941,962,950,978,943,953,993,971,957,911,976,908,931,964,931,953,929,920,926,929,880,893,992,848,899,818,891,827,864,834,853,824,884,901,807,834,815,867,839,867,857,853,814,911,808,871,843,819,859,891,824,820,850,909,923,866,936,888,876,900,935,856,880,930,939,963,951,936,943,952,933,936,919,878,948,890,949,915,975,958,922,924,918,945,977,890,1035,913,898,912,891,878,911,905,924,947,920,887,928,978,967,922,893,906,937,963,963,936,942,945,977,960,964,999,1076,1017,1033,1086,1103,1070,1167,1184,1205,1270,1380,1408,1500,1464,1556,1588,1678,1638,1824,1746,1922,1949,2033,2143,2120,2397,2318,2423,2535,2559,2550,2632,2722,2733,2827,2864,2926,2860,2988,2953,3105,3115,3041,2977,2947,2983,2866,2925,2813,2864,2841,2668,2631,2638,2578,2481,2429,2390,2283,2219,2150,1981,1976,1934,1902,1867,1689,1717,1612,1593,1656,1490,1428,1374,1440,1394,1299,1245,1249,1226,1222,1212,1168,1204,1192,1224,1141,1193,1081,1156,1081,1140,1100,1096,1108,1082,1096,1098,1134,1086,1156,1121,1038,1157,1129,1156,1106,1088,1116,1091,1108,1142,1154,1188,1142,1129,1136,1181,1167,1120,1174,1156,1206,1177,1187,1184,1173,1213,1270,1271,1251,1193,1285,1214,1218,1191,1259,1212,1259,1232,1245,1230,1217,1259,1268,1273,1259,1227,1254,1299,1239,1346,1309,1290,1361,1304,1358,1285,1329,1373,1372,1316,1374,1318,1396,1428,1365,1411,1439,1425,1420,1467,1501,1457,1460,1475,1456,1557,1455,1568,1486,1601,1496,1577,1547,1565,1558,1571,1547,1639,1590,1624,1546,1634,1623,1733,1568,1682,1684,1680,1677,1703,1734,1668,1713,1697,1727,1689,1739,1673,1729,1676,1817,1676,1671,1797,1706,1718,1775,1772,1732,1786,1740,1789,1847,1749,1829,1868,1876,1806,1894,1802,1867,1850,1957,1945,1864,1868,1881,1940,1929,1956,1957,1943,1974,2028,1945,1946,2020,1992,2043,2114,2032,2088,1997,2120,2061,2087,2205,2180,2182,2201,2231,2305,2236,2175,2270,2275,2326,2229,2275,2300,2341,2378,2363,2398,2401,2454,2409,2455,2543,2489,2566,2492,2528,2586,2537,2584,2488,2504,2567,2648,2602,2602,2685,2688,2705,2747,2790,2876,2758,2897,2895,2959,2959,2998,2988,3046,3102,3013,3180,3074,3110,3261,3167,3210,3319,3258,3463,3375,3436,3473,3377,3541,3520,3653,3688,3847,3763,3871,3882,3897,4068,4132,3954,4088,4159,4219,4230,4231,4456,4472,4474,4615,4506,4677,4588,4757,4604,4878,4777,4860,4952,5028,4954,5038,5096,5283,5171,5254,5120,5039,5193,5331,5207,5307,5205,5285,5305,5450,5550,5420,5404,5369,5465,5469,5414,5399,5493,5430,5711,5524,5537,5731,5685,5698,5804,5749,5878,5916,5841,5836,5928,6042,5985,5991,6143,6330,6340,6291,6192,6427,6492,6572,6622,6820,6861,6787,6795,7074,7096,7107,7058,7254,7151,7422,7496,7540,7539,7623,7692,7964,7905,7973,8095,8188,8115,8276,8324,8349,8521,8525,8866,8784,9048,8952,9097,9226,9299,9268,9354,9542,9490,9734,9740,9708,9995,10241,10137,10323,10349,10531,10649,10616,10973,10857,11151,11163,11301,11247,11541,11453,11290,11758,12101,11963,12168,12274,12661,12402,12786,12994,12797,13066,13085,13185,13532,13578,13563,13969,13781,14345,14075,14406,14453,14725,14818,14791,14927,15109,15131,15470,15743,15843,16021,16287,16323,16586,16660,16742,16914,17080,17170,17369,17537,17455,17850,17863,18010,18257,18486,18784,18855,19004,18809,19449,19389,19535,19691,19823,19716,20196,20268,20478,20925,20830,21083,21543,21595,21621,21705,21943,22266,22563,22658,22722,22951,23081,23409,23530,23887,23857,24260,24779,24681,24804,25324,25620,25701,25923,26099,26902,26927,27024,27563,27274,28035,28361,28945,28942,29693,29632,30208,29990,30715,31118,32005,31965,31997,33028,33245,34178,34305,34574,35589,35830,36245,37126,37635,38144,38559,39320,40044,40610,41160,41579,42688,43362,44219,45013,45641,47063,47046,47704,49005,49695,50540,51431,52589,53533,54676,55518,56442,58134,58817,60014,61124,62244,63971,64567,65921,67084,68381,69049,70697,72055,73392,75323,76000,77758,79227,80774,82379,83910,85415,86904,87970,89934,90774,93068,94541,95935,98232,99468,100881,103055,104657,106974,108004,110190,111589,113800,115496,117194,118457,120411,122105,123733,125345,127428,128916,131559,132847,134329,136433,137960,139627,140679,143269,145205,145829,147921,149104,150983,152689,154474,156343,157395,159163,160924,162010,163709,165204,167151,167551,169622,170741,172575,173809,174441,176441,177350,178874,180280,181714,181927,183639,185404,185541,186759,187859,188824,189791,190773,191821,192541,192903,194324,194984,195776,197030,198176,197641,198717,200022,200489,201723,201939,201678,202932,203642,204403,204608,205344,206584,206685,206513,207119,206981,209196,207937,209465,209067,209286,209766,209542,210203,211471,210925,211471,212248,211355,212158,213056,212103,213134,212606,212441,213455,213359,213920,213655,213760,213441,214272,215500,214558,214259,214245,215526,216047,215040,215831,215569,215992,215332,215686,215935,216213,216284,215815,216760,216983,216345,215708,216177,217213,216166,215884,215823,216758,217132,217353,216497,215533,216458,214909,215056,215603,215939,215032,214662,215974,214802,214801,215202,214037,213364,213182,213178,212988,213367,212778,212750,212948,212418,211988,212210,212275,211195,211904,212560,213511,212642,212146,212739,213437,214390,214636,216221,217603,218057,219549,221346,221785,223794,225919,227471,229094,230770,232741,235747,237126,240123,242858,244978,248461,251143,252204,255678,258130,261171,264916,266728,268823,270992,273927,275303,277318,279870,281043,282984,283514,283703,285923,285005,284887,284537,284216,283815,282147,279550,279261,275314,272898,269655,265386,261513,257416,253136,248602,242831,236796,230545,225052,217850,211898,204368,198219,189950,183427,176131,168236,160348,153340,145237,137953,131802,124134,117085,110732,103905,97498,91229,85516,79919,74018,69201,64134,59334,55036,50694,46849,43031,40029,36763,33644,31010,28772,26132,24072,22019,20759,18665,17518,16132,14817,13817,12832,11993,11255,10586,9785,9238,8746,8106,7796,7512,7046,6644,6415,6325,6068,5812,5549,5471,5179,5147,5121,4898,4664,4739,4493,4361,4246,4253,4228,4113,3921,3772,3817,3754,3561,3549,3442,3392,3345,3195,3211,3154,3083,3027,2907,2857,2935,2768,2743,2690,2673,2576,2556,2443,2405,2361,2334,2250,2273,2121,2209,2120,2040,2048,1954,1935,1876,1942,1834,1753,1776,1693,1662,1668,1625,1614,1529,1506,1447,1495,1451,1418,1357,1392,1394,1263,1271,1295,1263,1196,1163,1146,1160,1131,1061,1073,1066,1105,1012,987,1012,1036,928,924,981,909,920,914,830,897,806,855,800,729,796,806,781,747,738,762,739,681,706,686,676,678,720,601,638,639,574,659,640,608,619,580,556,553,566,562,565,546,506,537,574,520,528,560,527,532,493,507,544,499,478,502,466,510,443,452,497,424,446,454,425,449,426,409,449,401,430,424,420,379,399,397,416,381,401,386,368,374,383,358,394,363,371,378,444,338,406,329,359,370,369,329,345,357,341,336,362,378,322,344,366,315,340,315,330,370,345,333,317,323,323,283,326,316,323,273,286,320,296,311,325,290,293,303,317,288,314,321,299,291,291,268,272,288,294,324,308,262,275,287,287,258,289,258,276,260,265,293,290,293,285,267,258,244,280,286,273,264,257,245,236,262,268,238,258,263,231,248,249,256,228,224,244,236,248,237,231,240,279,218,242,238,223,223,238,225,236,216,253,242,205,226,223,246,248,210,233,241,240,242,223,201,215,228,189,220,210,203,200,191,213,226,194,225,224,202,196,196,206,199,199,196,170,193,185,173,208,200,200,204,202,209,181,193,183,162,202,175,177,200,187,198,190,221,180,196,198,202,224,221,206,225,204,209,229,243,229,226,231,239,232,238,238,201,209,233,256,235,243,220,242,233,257,237,202,227,244,217,195,199,216,214,209,181,179,191,177,193,172,166,131,158,147,138,130,132,122,110,126,122,135,111,94,104,93,103,102,92,71,74,82,77,81,76,95,77,73,75,77,76,75,79,80,63,68,65,55,71,76,65,65,70,72,69,61,75,65,59,76,56,64,60,73,76,68,68,66,67,79,75,62,65,70,56,72,69,68)
spectrum=c(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,1,5,8,10,28,65,74,203,341,580,988,1623,2701,4349,6734,10208,15334,22927,32442,46123,63165,85634,112923,145637,183330,227422,275505,325726,378314,428875,475854,518354,548603,572550,581911,580415,566496,540740,504869,462015,413764,363080,311826,262080,216079,175066,138201,107560,81329,61015,44533,31929,22384,15534,10652,7120,4635,3030,2029,1295,808,550,357,266,208,150,108,97,93,79,81,79,62,49,54,48,55,45,47,42,45,23,18,29,21,17,13,19,10,17,30,35,30,38,26,42,36,47,41,65,90,225,488,1183,1934,2598,3185,3236,3273,3240,3200,3193,3128,3091,3137,3029,3046,3056,3074,3085,2941,2945,2892,2792,2830,2768,2836,2725,2833,2804,2837,2730,2709,2694,2583,2627,2659,2641,2646,2642,2620,2641,2597,2587,2535,2567,2479,2460,2502,2624,2535,2511,2454,2404,2389,2408,2441,2408,2378,2434,2385,2344,2370,2341,2373,2415,2411,2360,2309,2322,2350,2341,2293,2337,2289,2319,2348,2264,2207,2297,2331,2322,2181,2180,2234,2131,2279,2279,2232,2254,2292,2127,2193,2258,2231,2231,2175,2165,2201,2205,2132,2168,2167,2153,2215,2094,2191,2188,2147,2071,2086,2103,2089,2083,2127,2084,2132,2095,2004,2098,2112,2142,2037,2105,2069,2020,2015,1980,1955,2088,2039,1996,2086,2090,1924,2098,1988,2051,2045,2080,2040,2114,2021,2010,2001,2009,1968,1962,1966,1964,1953,1968,1887,1957,1883,1804,1804,1756,1731,1840,1777,1718,1785,1683,1667,1674,1688,1715,1760,1700,1672,1707,1731,1740,1671,1715,1727,1648,1619,1717,1683,1685,1634,1709,1713,1722,1698,1767,1774,1671,1746,1609,1622,1638,1703,1608,1571,1634,1622,1645,1502,1660,1626,1654,1634,1680,1688,1628,1782,1907,1898,2019,2242,2413,2612,2868,3200,3733,4088,4534,5021,5689,6457,7123,7893,8405,9399,9748,10194,10987,11291,11580,12029,11780,11661,11676,11393,10956,10717,10222,9654,9419,8745,8181,7676,7144,6902,6503,6215,5921,5514,5380,5084,5004,4872,4835,4789,4829,5268,5784,6324,7182,8332,9976,12011,14198,17330,21017,24701,29500,34609,40044,46364,52682,58949,65909,72090,78064,83488,88919,93117,96311,97397,98239,97039,96188,93106,89134,84526,78827,72833,66982,60621,54212,48320,42787,37641,32432,28213,24485,21005,18520,15771,13824,11700,10349,9214,8166,7386,6501,5926,5476,4940,4588,4169,3877,3717,3662,3426,3173,3112,3203,3028,2967,2862,2881,2719,2853,2785,2638,2668,2600,2627,2482,2357,2386,2348,2401,2224,2199,2065,2114,1988,1934,2009,1904,1860,1807,1749,1775,1737,1747,1652,1674,1588,1546,1560,1558,1479,1502,1421,1431,1476,1407,1446,1435,1412,1338,1387,1356,1384,1439,1363,1373,1341,1403,1416,1350,1385,1306,1362,1426,1399,1400,1449,1437,1483,1458,1434,1407,1466,1490,1469,1480,1451,1411,1434,1430,1442,1511,1452,1485,1463,1358,1467,1451,1377,1435,1373,1370,1382,1360,1351,1329,1371,1316,1343,1329,1338,1333,1287,1327,1380,1410,1360,1377,1285,1277,1402,1273,1312,1250,1301,1321,1377,1276,1289,1342,1225,1249,1240,1300,1314,1310,1282,1242,1295,1321,1268,1324,1350,1329,1350,1360,1457,1411,1425,1389,1394,1479,1466,1418,1474,1450,1466,1451,1492,1410,1451,1522,1452,1494,1532,1560,1491,1520,1565,1536,1541,1462,1567,1525,1621,1637,1603,1583,1650,1598,1661,1561,1632,1669,1600,1644,1551,1607,1560,1584,1574,1511,1551,1526,1512,1536,1532,1561,1479,1571,1593,1581,1617,1592,1627,1667,1691,1735,1743,1841,1791,1867,1847,1921,1923,1997,2034,2072,2037,2020,2044,1981,1966,1965,1949,1977,1928,1892,2016,1906,1901,1800,1755,1746,1726,1794,1783,1672,1803,1814,1723,1723,1795,1789,1792,1823,1924,1846,1903,2011,2050,2073,2266,2307,2549,2644,2870,3150,3576,4114,4626,5174,6147,7310,8949,10568,12956,15233,18093,21621,25849,30155,35542,41034,47941,55219,62886,71160,79527,88477,97056,106279,115202,123574,130841,137801,143602,148518,151412,154251,154220,153894,151947,147491,142999,136989,129606,122162,113542,105155,96014,86725,77760,68945,61244,53316,46330,39809,33930,28925,24331,20227,17082,14230,12017,10075,8519,7363,6423,5829,5480,5058,5236,5138,5456,5809,6320,6935,7614,8479,9419,10328,11322,12584,13914,15136,16688,18129,19657,21440,23047,25148,26890,28874,30819,33075,35877,38720,41364,44454,47781,50975,54330,57965,61730,65350,69622,72594,76566,79575,82333,84214,86711,87639,88056,88566,87606,86844,84117,81525,78114,74509,70009,65449,61390,56335,51505,46442,41787,37352,32480,29167,24904,21790,18591,15863,13383,11455,9673,7870,6711,5449,4717,4019,3497,2984,2616,2456,2120,2108,2111,2063,2093,2168,2199,2419,2578,2866,3136,3360,3701,4121,4436,4919,5383,5839,6380,7097,7401,7930,8571,9125,9733,10343,10652,11018,11485,11713,11956,11881,11939,12070,11592,11544,11153,10801,10265,9828,9150,8814,8004,7450,6790,6112,5669,5090,4687,4242,3656,3371,2917,2637,2320,2086,1834,1750,1537,1478,1335,1272,1185,1170,1077,1026,1049,1021,1011,980,971,971,985,997,963,944,1059,1023,918,1062,1053,1010,1068,1032,1059,1141,1098,1176,1213,1212,1269,1377,1468,1488,1588,1714,1920,2114,2299,2599,2763,3266,3615,4130,4582,5217,5826,6725,7375,8566,9617,10813,12115,13322,14841,16055,17397,18999,20379,21876,23192,24906,26193,27286,28163,29447,29888,30548,30605,30965,31009,30503,29637,29013,28407,26979,25914,24461,23276,21784,20703,18651,17664,16047,14616,13458,12157,11177,10105,9343,8295,7581,7058,6503,5959,5496,5158,4879,4549,4439,4110,3955,3914,3599,3468,3387,3308,3267,3116,3109,2965,3091,2978,3086,3199,3175,3219,3496,3656,3766,3900,4182,4564,4832,5059,5434,5812,6216,6577,6834,7134,7494,7858,7957,8298,8441,8497,8829,8806,9043,9162,8936,9161,9220,9084,9222,8852,8891,8864,8711,8549,8560,8404,8267,8229,7933,7675,7448,7131,7022,6693,6476,6019,5982,5549,5287,4730,4600,4370,4155,3938,3678,3404,3155,2910,2806,2795,2539,2384,2298,2322,2236,2144,2184,2149,2129,2151,2110,2211,2263,2210,2254,2373,2475,2305,2347,2560,2599,2634,2774,2741,2625,2768,2728,2737,2721,2753,2723,2703,2749,2683,2667,2679,2614,2568,2581,2474,2485,2540,2375,2439,2321,2438,2278,2217,2242,2125,2120,2099,2087,2083,1947,1951,1914,1911,1839,1945,1873,1810,1826,1682,1736,1750,1710,1758,1624,1667,1736,1631,1635,1654,1701,1575,1625,1691,1678,1683,1661,1727,1700,1750,1733,1772,1763,1827,1824,1787,1896,1825,1815,1906,1923,1900,1980,1946,1967,2007,1928,1998,1893,1879,1942,1765,1869,1709,1849,1777,1707,1740,1679,1550,1619,1624,1586,1625,1494,1520,1572,1451,1532,1494,1513,1466,1476,1494,1540,1513,1604,1569,1637,1673,1645,1715,1731,1805,1844,1954,1901,2131,2109,2155,2208,2458,2520,2518,2716,2827,3022,3109,3339,3445,3661,3748,4024,4184,4333,4669,4743,4915,5041,5209,5373,5486,5543,5753,5735,5734,5777,5769,5826,5577,5493,5446,5277,5146,4988,4617,4533,4365,4122,3993,3781,3544,3391,3166,3122,3017,2866,2701,2520,2559,2475,2304,2273,2213,2199,2098,2200,2126,2224,2202,2146,2143,2042,2110,2137,2171,2310,2185,2292,2333,2429,2470,2521,2483,2567,2678,2744,2933,2963,3088,3248,3478,3790,4064,4501,4792,5447,6039,6940,7884,9050,10632,12279,14475,17197,20055,24209,28160,32897,39090,45614,53539,61910,72114,82394,94827,107917,121959,138186,154124,171685,191723,210311,229628,250959,271289,291425,311041,331280,348558,365873,380334,395306,406074,415058,422358,424938,427930,427031,423114,416294,406843,394748,380628,366984,350278,331100,311753,292893,272275,251733,231310,211767,192015,172980,156139,138479,122143,108580,94285,82878,71287,61518,53011,45049,38152,32056,27191,22862,18901,15548,13217,10965,9124,7577,6388,5346,4447,3883,3414,3002,2640,2387,2198,2020,1859,1777,1698,1607,1639,1514,1532,1526,1511,1378,1407,1366,1428,1342,1378,1343,1341,1374,1363,1352,1442,1462,1421,1397,1452,1497,1498,1518,1599,1549,1681,1655,1692,1733,1881,1838,1948,2025,2050,2145,2245,2502,2630,2696,2972,3127,3310,3603,4026,4464,4819,5383,6015,6604,7381,8365,9256,10280,11587,13069,14465,16096,17698,19882,21773,23967,26035,28508,30838,33321,35449,38237,41055,43428,45577,47718,49295,51261,52637,53836,54616,55511,56284,56234,55933,55029,54513,53528,51894,50123,48327,46853,44340,41792,39354,37016,34263,31674,29299,26947,24481,22254,20155,17938,16272,14240,12482,11218,9597,8595,7404,6397,5487,4871,4066,3468,2873,2563,2326,1824,1600,1436,1274,1113,982,840,740,710,686,607,588,527,503,522,449,471,444,472,493,455,446,465,468,477,498,492,473,500,487,539,533,582,562,565,590,558,610,614,626,653,632,672,661,631,666,647,673,621,618,615,668,628,629,581,583,596,556,592,531,580,479,503,485,458,440,481,450,410,418,395,420,407,421,385,370,391,330,355,370,369,345,370,380,331,333,357,326,348,318,343,346,375,375,356,386,353,378,365,340,384,349,368,336,359,404,361,380,363,381,371,404,385,432,403,442,447,445,429,485,447,491,473,472,485,517,499,509,526,522,469,499,523,496,518,555,528,521,595,544,539,590,608,596,610,609,593,655,649,684,720,724,654,753,778,745,773,756,811,787,824,796,799,849,810,816,803,827,811,840,930,865,817,788,745,777,786,809,717,734,762,686,686,640,590,631,647,576,622,558,542,562,544,505,523,488,485,454,478,482,462,460,419,452,455,400,418,414,371,384,398,414,369,393,353,396,348,344,374,361,336,398,372,373,337,356,356,383,363,340,333,364,387,388,389,383,392,397,387,440,457,471,474,538,575,593,614,684,738,799,860,887,1029,1126,1228,1297,1451,1590,1680,1892,2022,2221,2367,2546,2717,2926,3045,3198,3428,3534,3751,3718,3974,4267,4180,4369,4372,4430,4347,4324,4449,4234,4275,4155,4129,4033,3886,3902,3559,3440,3321,3161,2999,2848,2652,2405,2255,2081,1889,1818,1739,1473,1345,1286,1139,1128,954,867,878,801,706,637,622,582,526,526,495,492,513,472,450,444,445,441,450,381,382,416,416,416,391,428,406,395,429,421,412,418,409,407,395,437,389,452,421,406,435,368,393,388,417,419,422,411,451,416,438,400,462,438,439,471,475,456,459,478,459,502,486,545,490,537,556,605,650,678,715,752,763,763,904,906,1004,1062,1033,1122,1150,1224,1260,1293,1342,1336,1442,1450,1521,1605,1516,1602,1631,1660,1692,1641,1577,1687,1533,1605,1579,1509,1453,1390,1371,1289,1242,1261,1143,1156,1076,1027,1000,956,846,824,753,771,695,660,632,590,605,557,526,506,501,502,463,446,471,486,479,475,433,448,548,488,563,506,566,575,549,591,657,628,678,740,704,725,690,786,814,809,827,875,856,884,903,889,1013,898,909,903,925,951,912,886,898,887,950,936,874,891,899,911,892,826,808,841,822,777,753,840,779,774,769,729,683,711,679,703,696,626,610,616,568,607,611,547,520,518,516,474,507,514,491,473,465,466,425,413,438,434,431,429,434,394,413,401,406,398,383,409,388,406,388,395,391,392,422,397,368,439,398,380,392,402,397,442,429,374,410,420,436,452,432,434,449,471,456,460,471,437,460,477,459,506,497,509,472,523,497,496,483,518,448,525,475,479,478,490,475,480,471,469,464,470,461,487,480,466,465,464,475,460,478,495,481,514,494,485,504,519,510,556,548,519,532,567,568,542,551,556,527,521,555,535,533,520,512,488,560,503,522,522,539,551,520,532,530,529,596,654,588,618,633,669,669,677,742,713,734,777,800,880,869,893,952,956,1034,1038,1109,1130,1171,1163,1278,1254,1202,1301,1320,1270,1321,1275,1318,1374,1303,1363,1271,1353,1275,1268,1242,1298,1132,1200,1091,1087,1055,989,941,885,856,845,863,769,767,722,676,606,620,585,527,559,532,474,479,451,463,407,408,390,377,412,373,350,381,388,374,353,344,352,341,356,376,357,356,348,360,353,380,357,374,374,359,330,380,348,347,395,369,382,389,313,349,394,357,334,399,408,354,377,349,374,384,328,341,357,381,354,343,353,320,366,351,348,315,358,316,322,336,343,341,343,331,313,339,327,318,375,338,360,345,347,340,332,335,335,346,350,333,353,337,335,359,323,338,334,349,338,331,356,317,343,360,328,340,337,333,331,324,338,311,342,338,331,337,323,363,331,334,303,336,338,303,338,324,359,318,351,362,339,331,354,329,333,305,301,318,346,354,317,292,334,335,310,316,325,300,348,310,345,321,316,288,321,312,312,280,324,335,303,295,358,315,281,329,330,288,331,300,305,301,310,315,333,317,299,317,333,308,310,321,297,344,355,287,316,307,321,352,296,322,335,350,325,314,293,301,361,330,341,331,306,308,358,319,323,334,302,367,348,357,382,366,321,316,371,393,375,394,367,398,365,426,466,475,473,480,464,459,494,511,525,549,573,543,567,578,599,608,600,613,603,609,560,562,553,618,619,636,567,625,564,602,616,578,568,534,571,511,508,483,527,497,450,454,428,426,432,457,419,438,434,384,397,388,373,376,356,373,390,388,373,379,392,381,358,350,389,377,350,359,386,381,395,356,338,381,353,425,360,382,409,402,403,390,398,426,394,427,416,438,398,454,409,384,410,421,422,425,410,410,423,466,440,418,435,437,424,450,441,419,408,436,439,447,428,428,435,423,424,449,468,439,440,429,458,465,486,456,509,505,473,484,525,557,523,588,598,518,620,622,611,679,685,681,763,795,778,833,892,809,887,935,1009,984,1027,1016,1091,1091,1147,1149,1147,1113,1231,1207,1158,1305,1246,1229,1232,1293,1288,1346,1268,1301,1316,1294,1213,1272,1291,1294,1318,1257,1270,1157,1194,1195,1246,1200,1217,1169,1191,1147,1193,1177,1170,1157,1168,1151,1185,1169,1137,1160,1104,1169,1199,1183,1143,1109,1097,1188,1128,1122,1188,1098,1177,1116,1098,1096,1151,1106,1154,1148,1156,1151,1155,1218,1182,1178,1175,1164,1130,1166,1179,1177,1208,1224,1156,1147,1186,1123,1173,1082,1117,1025,1057,1083,1074,1057,1002,1032,916,883,887,918,875,885,809,840,789,815,815,788,836,825,880,873,870,909,910,971,988,1076,1053,1173,1192,1315,1454,1598,1599,1774,2070,2124,2351,2429,2746,2999,3182,3527,3733,4050,4424,4579,5030,5403,5665,6107,6596,6698,7238,7704,7993,8597,8807,9013,9372,9874,10145,10417,10878,10976,11336,11354,11708,11814,11973,11971,12222,11971,12055,12076,11828,11608,11529,11480,11328,10633,10587,10192,9956,9556,9205,8891,8524,8093,7651,7225,7023,6570,6113,5544,5456,5005,4622,4527,4143,3760,3443,3178,3018,2773,2517,2404,2188,1936,1851,1634,1609,1545,1348,1315,1263,1184,1077,1045,1006,964,935,879,890,859,845,806,821,824,784,784,735,753,767,688,740,684,760,721,729,695,690,701,695,719,676,722,756,715,731,757,748,780,743,738,723,780,736,837,855,825,892,866,895,913,926,972,1024,1123,1160,1248,1257,1288,1443,1524,1728,1836,2021,2252,2533,2644,2935,3200,3537,3857,4318,4710,5052,5748,6199,6735,7275,8299,8893,9489,10366,11320,12091,12989,14116,15139,16250,17243,18365,19731,20622,21628,23058,24354,25287,26212,27383,28385,29423,30520,31247,32293,33113,33723,33825,34487,35044,35171,35794,35670,35956,35936,35868,35390,35047,34328,33650,32908,32057,31395,30531,29850,28573,27634,26504,25259,23914,23081,21968,20897,19231,18229,17065,16086,14825,14017,12980,11692,11087,10287,9424,8470,7729,7127,6478,5916,5307,4856,4436,3963,3641,3289,3029,2707,2506,2326,2061,1860,1747,1517,1518,1353,1265,1185,1191,1091,1066,1021,985,941,945,936,868,900,848,884,899,900,836,865,831,856,874,782,898,891,837,872,860,796,845,856,864,882,861,835,845,838,917,888,908,875,871,912,871,974,905,908,902,974,936,1032,1039,978,1022,1005,1052,1049,1108,1069,1050,1149,1097,1082,1170,1233,1174,1145,1219,1312,1300,1258,1385,1349,1353,1416,1438,1506,1592,1726,1696,1735,1739,1921,1927,1891,1992,2084,2111,2221,2184,2328,2446,2519,2570,2611,2736,2805,2851,2962,2973,3050,3232,3183,3202,3249,3350,3411,3291,3383,3475,3277,3486,3478,3475,3448,3425,3483,3350,3342,3200,3230,3195,3143,3121,2924,2928,2912,2866,2874,2777,2621,2550,2484,2482,2440,2461,2301,2352,2267,2324,2203,2181,2110,2063,2054,2045,1985,1969,2053,2080,2036,1913,2019,1951,1933,1972,1974,2002,1974,1913,1999,1972,1927,1967,1980,2028,1959,1964,2008,1973,1938,2001,1988,1972,1943,1976,1901,2018,2034,2008,2088,2019,2003,2082,2117,2048,2069,2156,2061,2171,2060,2139,2124,2173,2209,2212,2331,2199,2273,2222,2241,2360,2347,2277,2424,2294,2361,2386,2466,2530,2502,2587,2481,2603,2623,2628,2575,2546,2585,2781,2789,2777,2789,2690,2767,2814,2856,2889,2894,2944,2966,2947,3043,3219,3097,3059,3180,3292,3326,3300,3416,3369,3458,3559,3707,3683,3732,3876,3996,4045,4182,4318,4379,4460,4617,4694,4873,5034,5055,5292,5485,5504,5815,5866,6130,6436,6612,6605,6949,7139,7211,7280,7578,7713,7905,8085,8222,8374,8480,8733,8631,8970,8891,9259,9259,9228,9260,9211,9271,9195,9198,9128,9019,9117,9062,8955,8789,8747,8812,8457,8423,8335,8662,8163,8191,8092,7969,7793,7803,7748,7716,7662,7477,7572,7508,7378,7459,7474,7435,7400,7493,7421,7526,7549,7621,7571,7782,7780,7931,7865,7973,8065,8261,8241,8365,8415,8468,8684,8835,8934,9008,9100,9301,9544,9544,9601,9680,9906,10065,10269,10235,10590,10554,10823,10882,11134,11270,11384,11559,11752,12055,12075,12437,12602,12838,13101,13325,13390,13626,13902,13943,14333,14656,14936,15311,15488,15969,15853,16334,16428,17108,17419,17548,17937,18015,18468,18917,19195,19651,19844,20359,20502,20627,21299,21714,21828,22683,23013,23542,23715,23877,24499,24779,25529,25757,26275,26516,26807,27418,27909,28057,29030,29351,29742,29770,30431,31055,31253,31832,32193,32717,33185,33601,34008,34303,34968,35308,36295,36653,36832,36939,37809,37891,38367,38837,39429,40018,40322,40600,41124,41441,42204,42174,42827,43319,43701,43976,44483,44876,45544,45762,46138,46528,46829,47071,47239,47982,48082,48650,49463,49208,50059,50196,50689,50268,51159,51620,51576,52589,52620,53251,52881,53432,53948,54125,54296,54594,54277,54767,55194,55351,55693,55871,55812,56301,56522,57074,57253,57597,57872,57258,57788,57838,58356,58579,58646,59051,58722,59027,59502,59268,59803,60028,59574,60341,60065,60550,60830,60685,60232,60665,60832,60855,61076,61000,61220,61725,61366,61460,61624,61578,61966,62226,62060,62160,61588,61981,62253,62035,62235,61936,61955,62049,61932,61907,62037,61752,62019,62015,62084,61728,61997,61960,61975,61940,62076,62252,62473,62047,61990,62587,62345,62758,63177,63197,64077,63702,64592,65398,65590,66331,67777,67853,68504,69003,70639,71806,72396,73895,75385,77280,78486,80334,82367,83806,86364,87952,89597,92384,94668,97111,99446,102008,104362,106635,108998,111190,113733,116802,118752,122290,123975,126302,128924,130045,132269,133946,136078,137396,139028,139893,141064,142305,143197,143558,143397,143399,143104,142220,141748,140139,139595,138037,135560,134297,131620,129285,127010,123834,121083,117375,114416,111042,107729,103511,99980,96036,91909,87840,83105,79110,75784,71647,67773,64075,60575,56620,52898,49424,46217,43317,40298,37672,34483,31786,29226,27045,24597,22834,21064,19099,17666,16119,14597,13267,12280,11154,10094,9403,8272,7795,6998,6441,6099,5393,5188,4691,4351,3990,3833,3428,3277,3036,2864,2772,2572,2380,2357,2241,2189,2107,2092,1963,1872,1798,1733,1748,1667,1653,1582,1547,1388,1500,1421,1394,1308,1217,1257,1268,1221,1133,1197,1120,1058,1085,1087,1013,1038,1016,981,945,858,950,865,895,874,914,768,814,795,735,730,720,659,638,665,708,618,595,585,644,597,570,576,566,530,496,546,540,486,473,494,491,450,484,425,421,438,406,421,414,412,410,351,366,420,391,368,354,361,368,356,339,307,322,290,339,296,277,272,293,282,285,259,292,283,275,298,278,244,276,276,232,261,240,238,278,236,234,234,235,220,239,241,215,205,229,198,207,202,208,202,219,180,196,170,225,198,204,176,205,172,193,186,206,209,202,172,184,171,171,194,201,167,179,195,188,163,172,184,181,169,166,186,178,181,175,165,151,192,163,161,166,166,189,184,161,169,167,180,170,157,162,135,163,189,145,160,145,149,157,171,143,177,161,164,171,156,174,144,153,143,156,135,143,150,136,172,148,152,157,159,152,140,159,166,166,143,152,157,152,149,150,156,161,139,138,142,139,146,157,160,133,153,169,158,161,168,146,175,183,165,156,156,155,169,155,135,160,164,166,168,167,178,185,198,177,188,160,188,191,171,164,146,193,192,164,188,202,188,160,187,181,180,177,176,198,188,196,191,157,189,177,189,174,159,161,156,173,161,154,171,173,151,155,174,173,123,164,144,144,150,136,119,138,127,128,112,102,122,113,129,96,116,116,102,111,98,92,97,80,93,80,82,83,82,87,97,90,84,109,89,92,87,98,104,74,87,77,84,84,89,91,95,97,101,84,89,88,102,125,105,105,105,128,104,135,104,114,109,114,120,108,110,109,114,137,116,141,133,141,137,108,146,128,141,139,101,96,140,135,139,115,107,124,126,109,124,104,104,125,136,122,104,97,123,97,131,119,103,110,104,96,93,95,105,86,110,94,104,99,111,98,107,79,102,84,89,93,101,96,99,88,112,92,82,98,97,94,65,105,89,77,82,95,76,104,88,77,82,98,87,82,102,104,103,91,78,104,99,85,103,86)
nach=function(spectrum,x0, a,b){

	p=list()
	p$fwhm=1.0
	rc0     = find_pike(spectrum,   x0_gauss,  x0, 1,  a, b, eps=0.01, params=p)

	p=list()
	p$x0 = rc0$x
	rc0fwhm = find_pike(spectrum, fwhm_gauss,  1, 1,  0,100, eps=0.001, params=p)

	p=list()
	p$fwhm=rc0fwhm$x
	rc0     = find_pike(spectrum,   x0_gauss,  rc0$x, rc0$A,  a, b, eps=0.01, params=p)

	p=list()
	p$x0 = rc0$x
	rc0fwhm = find_pike(spectrum, fwhm_gauss,  rc0fwhm$x, rc0fwhm$A,  0,1800, eps=0.001, params=p)

	h=list()
	h$x0=rc0$x
	h$fwhm=rc0fwhm$x
	h$A=rc0fwhm$A
	h$variance=rc0fwhm$variance
	h$X=rc0fwhm$X
	h
}
 
rc0=nach(spectrum, 0, 0, 200)
rcFe = nach(spectrum,1500,1300,1800)
print(rc0)
print (rcFe)
#print(rcCom)
gaus = gauss_stru(rc0)
gausFe = gauss_stru(rcFe)
#gausCom = gauss_stru(rcCom)
#print(gausFe)

#rcFe = find_pike(spectrum, x0_gauss, x0, 1, a, b, eps=0.01, params=p)

x <- c(0.0086, 6.4)

xsq=sqrt(x)
print(xsq)
#y <- c(rc0$fwhm,rcFe$fwhm)
y <- c(rc0$fwhm,rcFe$fwhm)
print(y)
mfwhm=lm(y~xsq+0)
cmfwhm=coefficients(mfwhm)

#t=cmfwhm[1]
k=cmfwhm[1]
 print(cmfwhm) 
fwhmRel=sqrt(17.41) * k 
fwhmZr=sqrt(15.774) * k 
print (c(fwhmRel, fwhmZr))

SC = (rcFe$x0-rc0$x0) / (6.4-0.0086)
GAIN = 1/SC
ZERO = - GAIN*rc0$x0
C0 = rc0$x0


rcRel=list()
rcRel$A=rc0$A
rcRel$x0=C0 + 17.41 * SC 
#fwhmRel = fwhmRel*1.35
rcRel$fwhm=fwhmRel


gausRel=gauss_stru(rcRel)
print(fwhmRel)

rcZr=list()
rcZr$A=rcFe$A/40
rcZr$x0=C0 + 15.774 * SC
rcZr$fwhm=fwhmZr
gausZr=gauss_stru(rcZr)
print(fwhmZr)

q=pi/2
m0=510.996
E0=17.41
 Ec=E0 #seq(15.0,17.415, by=0.1)
 de=(E0*Ec/m0)*(1-cos(q))
 #print(de)
 dE=max(de)
 dE=de
#Ecom=list()
Ecom=E0-dE
#fwhmCom=sqrt(Ecom) * k + t
#print(Ecom)
 #rcCom=list()                            
 #rcCom$A=rc0$A/2.7
 #rcCom$x0=C0 + Ecom * SC
 #rcCom$fwhm=fwhmCom 
 #gausCom=gauss_stru(rcCom)

Fa=seq(0.001,2.0, by=0.001)                   #1.1
Fb=seq(0.001,2.0, by=0.001)                      #0.6
ya=seq(1,10.00,by=0.02)  # 9
yb=seq(1,10.00, by=0.02) #4
fg=2.9                   
Com=GAIN * X + ZERO
sig = (fwhmRel * GAIN / 2.35482) 
dE=(Com-Ecom)

Arel=rcRel$A
sq2=sqrt(2)

erfc <- function(x) {
	2 * pnorm(x / sq2, lower=F)
}

plus=erfc((dE/(sq2*sig))+1/(sq2*ya))
minus=erfc((-dE/(sq2*sig))+1/(sq2*yb))
Ta=Arel*(GAIN/(2*ya*sig*exp(-1/(2*ya^2))))*plus*exp(dE/(ya*sig))
Gc=Arel*(GAIN/(sqrt(2*pi)*sig*fg))*exp(-0.5*((dE/(sig*fg))^2))
#Gc=sim_gauss(Com, Ecom, Arel, fwhm=fwhmRel * fg * GAIN)
Tb=Arel*(GAIN/(2*yb*sig*exp(-1/(2*yb^2))))*minus*exp(-dE/(yb*sig))
#yi=Gc+Fa*Ta+Fb*Tb+gausRel
#3250:4095 


intervl=3100:4095

sp=spectrum[intervl]
gc1=Gc[intervl]
ta1=Ta[intervl]
tb1=Tb[intervl]
rel1=gausRel[intervl]
m_cou = lm(sp ~ gc1+ta1+tb1+rel1) #+Zr1)
cc = coefficients(m_cou)
print (cc)

png('cou.png')
yyyy = cc[1]+cc[2]*gc1+cc[3]*ta1+cc[4]*tb1+cc[5]*rel1
plot(sp, type='l')
#lines(cc[0]+cc[1]*gc1+cc[2]*ta1*Fa+cc[3]*tb1*Fb+cc[4]*rel1, col='red')
lines(yyyy, col='red')
dev.off()


yi=(cc[1]+cc[2]*Gc+cc[3]*Ta+cc[4]*Tb +cc[5]*gausRel)
#yi=(cc[1]+cc[2]*Gc+cc[3]*Ta*Fa+cc[4]*Tb*Fb +cc[5]*gausRel) #+cc[6]*gausZr)


#print(yi)
# print(Gc)
LOG=F
if (LOG) {
    spectrum=log(spectrum)
    gaus=log(gaus)
    gausFe=log(gausFe)
    gausRel=log(gausRel)
    gausZr=log(gausZr)
    #gausCom=log(gausCom)
}
png("plot.png", width=1024, height=800)
plot(spectrum, type='l', col='black')
grid(15, 15, lwd = 2)
grid(lwd = 1, col='black')
lines(gaus,type='l', col='red')
lines(gausFe,type='l',col='green')
#lines(gausRel,type='l',col='blue')
#lines(fwhmRel, type='l', col='blue')
#lines(gausZr, type='l', col='blueviolet')
#lines(fwhmZr, type='l', col='blueviolet')
line.xrf.mark(rc0$x, spectrum, col='black')
line.xrf.mark(rcFe$x, spectrum, col='green')
line.xrf.mark(rcZr$x, spectrum, col='magenta')
line.xrf.mark(rcRel$x, spectrum, col='darkorchid')

##plot(x=X, yi, type='l')
##plot(x=X, Gc, type='l')
#lines(x=X, Gc, col='red')
#lines(x=X, Tb, col='blue')
#lines(x=X, Ta, col='green')
lines(x=X, yi+gausZr, col='cyan')



dev.off()                      
#png("plot.png", width=1024, height=800)
#Zr=(15.774-ZERO)/GAIN
#print(Zr)
#rcZr=nach(spectrum,Zr-fwhmZr, Zr, Zr+fwhmZr)
#plot((spectrum-X-yi)[200:4095], type='l', col='black')    
#plot((spectrum-yi), type='l', col='black')
#plot((spectrum-X-yi-gausRel), type='l', col='black')
#lines(gausZr, type='l', col='blue')   
#line.xrf.mark(Zr, spectrum, col='magenta')
#dev.off()